---
- name: Provision PostgreSQL Database
  hosts: all
  become: true

  vars:
    postgres_user: dbadmin
    postgres_password: StrongP@ssw0rd
    postgres_db: sampledb

  tasks:
    - name: Install PostgreSQL
      apt:
        name: postgresql
        state: present
      when: ansible_os_family == "Debian"

    - name: Ensure PostgreSQL is running
      service:
        name: postgresql
        state: started
        enabled: yes

    - name: Set PostgreSQL password
      become_user: postgres
      shell: |
        psql -c "ALTER USER {{ postgres_user }} WITH PASSWORD '{{ postgres_password }}';" || \
        psql -c "CREATE USER {{ postgres_user }} WITH PASSWORD '{{ postgres_password }}';"
      args:
        executable: /bin/bash

    - name: Create PostgreSQL database
      become_user: postgres
      postgresql_db:
        name: "{{ postgres_db }}"
        owner: "{{ postgres_user }}"
